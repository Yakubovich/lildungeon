<!DOCTYPE html>
<html>
  <head>
    <title>Canvas Test</title>
    <style>

      body {
        background: url("bg.png");
      }

      #game {
        margin-top: 100px;
        border: 0px solid black;
        border-radius: 10px;
        background: url("grass.jpg");
        box-shadow: 0px 0px 100px 0px black;
      }

    </style>
	  <script src="jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      var canvasWidth = 500;
      var canvasHeight = 500;
      var SPEED = 3;
      var DOWN = 0;
      var UP = 1;
      var LEFT = 2;
      var RIGHT = 3;
      
      var ctx;
      var player;
      var sprites = [];

      $(document).ready(function() {
        player = new Sprite({ src:    "bluelink.png",
                              width:  30,
                              height: 25,
                              xPos:   50,
                              yPos:   50,
                              stop:   true
                            });
        sprites.push(player);
        for (var i = 0; i < 20; i++) {
          sprites.push(new Sprite({ src: "redlink.png",
                                    width:  30,
                                    height: 25,
                                    xPos:   Math.round(Math.random() * canvasWidth),
                                    yPos:   Math.round(Math.random() * canvasHeight)
                                   }));
        }
        
        var wolf = new Sprite({ src:         "wolf.png", 
                                width:       38,
                                height:      39,
                                xPos:        Math.round(Math.random() * canvasWidth), 
                                yPos:        Math.round(Math.random() * canvasHeight),
                                totalframes: 3
                              });
        sprites.push(wolf);
        var drunk = new Sprite({ src:      "drunklink.png",
                                 width:    30, 
                                 height:   25,
                                 xPos:     300,
                                 yPos:     100,
                                 turnprob: 0.6
                                });
        sprites.push(drunk);

        setInterval(draw,50);
        ctx = $('#game')[0].getContext('2d');
      });

      function draw() {
        ctx.clearRect(0,0,500,500);
        $(sprites).each(function(index) {
          if (this != player && Math.random() > this.turnProb) {
            this.direction = Math.round(Math.random() * 3);
          }
          
          if (this.image.loaded) {
            this.nextFrame();
          }
        });

        /* Sort by Y position so that lower sprites overlap higher ones */
        sprites.sort(function(a, b) {
          var a1 = a.yPos + a.height, b1 = b.yPos + b.height;
          if (a1 == b1) return 0;
          return a1 > b1 ? 1 : -1;
        });
      }

      /* Requied args: src, width, height, xPos, yPos */
      /* Optional args: turnprob, totalframes, stop */
      function Sprite(args) {
        this.frame = 0;
        this.width = args.width;
        this.height = args.height;
        this.xPos = args.xPos;
        this.yPos = args.yPos;
        this.direction = DOWN;
        this.image = new Image();
        this.image.src = args.src;

        if (args.turnprob)
          this.turnProb = args.turnprob;
        else
          this.turnProb = 0.95;

        if (args.totalframes)
          this.totalframes = args.totalframes;
        else
          this.totalframes = 11;

        if (args.stop)
          this.stop = true;
        else
          this.stop = false;

        this.image.onload = function() {
          this.loaded = true;        
        };
        this.drawFrame = function(row, col) {
          if (row >= 0) {
            ctx.drawImage(this.image, this.width*col,row * this.height,this.width,this.height,this.xPos,this.yPos,this.width,this.height); 
          } else {
            row = -row;
            ctx.drawImage(this.image, this.width*col,row*this.height,this.width,this.height,-this.xPos - this.width,this.yPos,this.width,this.height); 
          }
        };
        this.nextFrame = function() {
          switch(this.direction) {
            case DOWN: 
              this.drawFrame(0, this.frame);
              if (!this.stop)
                this.yPos += SPEED;
              break;
            case UP:
              this.drawFrame(1, this.frame);
              if (!this.stop)
                this.yPos -= SPEED;
              break;
            case LEFT:
              this.drawFrame(2, this.frame);
              if (!this.stop)
                this.xPos -= SPEED;
              break;
            case RIGHT:
              ctx.save();
              ctx.scale(-1,1);
              this.drawFrame(-2, this.frame);
              ctx.restore();
              if (!this.stop)
                this.xPos += SPEED;
              break;
          }

          if (this.stop) {
            this.frame = 0;
          } else {
            this.frame++;
            if (this.frame == this.totalframes)
              this.frame = 0;
            if (this.xPos >= canvasWidth)
              this.direction = LEFT;
            if (this.xPos <= 0)
              this.direction = RIGHT;
            if (this.yPos >= canvasHeight)
              this.direction = UP;
            if (this.yPos <= 0)
              this.direction = DOWN;
          }
        };
      };

      $(document).keydown(function(e) {
        switch(e.keyCode){
          case 40:
            player.direction = DOWN;
            player.stop = false;
            break;
          case 38:
            player.direction = UP;
            player.stop = false;
            break;
          case 39:
            player.direction = RIGHT;
            player.stop = false;
            break;
          case 37:
            player.direction = LEFT;
            player.stop = false;
            break;
        }
      });

      $(document).keyup(function(e) {
        switch(e.keyCode){
          case 40:
            if (player.direction == DOWN)
              player.stop = true;
            break;
          case 38:
            if (player.direction == UP)
              player.stop = true;
            break;
          case 39:
            if (player.direction == RIGHT)
              player.stop = true;
            break;
          case 37:
            if (player.direction == LEFT)
              player.stop = true;
            break;
        }
      });
    </script>
  </head>
  <body>
    <center>
      <canvas id="game" width="500" height="500"></canvas>
    </center>
  </body>
</html>
